<?php
class SitesController extends AppController {

	var $name = 'Sites';
	var $helpers = array('Html', 'Form');
	var $components = array('Acl');

	function CheckAcl($aroItem = null, $acoItem = null, $option = '*')
	{
		if(!$aroItem || !$acoItem )
		{
			return false;	
		}

		$aroPath = $this->Acl->Aro->node($aroItem);
		$acoPath = $this->Acl->Aco->node($acoItem);

		if ( empty($aroPath) || empty($acoPath) )
		{
			return false;	
		}

		/* check if the user group has this right */
		$parent = $this->Acl->Aro->findByAlias($aroItem);
		if( $this->Acl->check($parent['Aro']['model'], $acoItem, $option) )
		{
			return true;
		}
		
		/* check if the user has this right */
		if( $this->Acl->check($aroItem, $acoItem, $option) )
		{
			return true;
		}
		
		return false;

	}

	function index() {
		$this->Site->recursive = 0;
		if( !$this->CheckAcl($this->Session->read('userid'), 'SitesList', '*') )
		{
			$this->Session->setFlash(__('您没有访问的权限。', true));
			$this->set('sites', $this->paginate('Site', Array('Site.id' => -1)));
		}
		else
		{
			$this->set('sites', $this->paginate());
		}
		//$this->set('sites', $this->paginate('Site',Array('account_id' => $this->Session->read('userid'))));
	}
	function MySites() {
		$this->Site->recursive = 0;
		$this->set('sites', $this->paginate('Site',Array('account_id' => $this->Session->read('userid'))));
	}

	function view($id = null) {
		if (!$id) {
			$this->Session->setFlash(__('Invalid site', true));
			$this->redirect(array('action' => 'index'));
		}
		else if( !$this->CheckAcl($this->Session->read('userid'), $id, 'read') )
		{
			$this->Session->setFlash(__('您没有访问该站点的权限。', true));
			$this->redirect(array('action' => 'index'));
		}
		else
		{
			$this->set('site', $this->Site->read(null, $id));
		}
	}

	function add() {
		if(!$this->CheckAcl($this->Session->read('userid'), 'SitesList', 'create'))
		{
			$this->Session->setFlash(__('您没有权限或者您没有登录。', true));
			$this->redirect('/');
		}
		else if (!empty($this->data)) {
			
			/* set the database item */
			$SiteInfo = Array();
			$SiteInfo['Site']['domain'] = $this->data['Site']['domain'];
			$SiteInfo['Site']['name'] = $this->data['Site']['name'];
			$SiteInfo['Site']['account_id'] = $_SESSION['userid'];
			$SiteInfo['Site']['created_at'] = date("Y-m-d	H:i:s");
			$SiteInfo['Site']['updated_at'] = date("Y-m-d	H:i:s");
			$SiteInfo['Site']['expired_at'] = date("Y-m-d	H:i:s");
			$SiteInfo['Site']['description'] = $this->data['Site']['description'];
			
			/* These Items Wait To Be Set */
			$SiteInfo['Site']['apikey'] = 'Wait To Set';
			/*$UserInfo['Site']['status'] = '';
			$UserInfo['Site']['maxusers'] = '';
			$UserInfo['Site']['apikey'] = '';*/
			
			$this->Site->create();
			if ($this->Site->save($SiteInfo)) {
				
				/* Get Site id */
				$results = $this->Site->findByName($SiteInfo['Site']['name']);
				
				/* insert into aco(Accounts) */
				$parent = $this->Acl->Aco->findByAlias('SitesList');
				$this->Acl->Aco->create(array(
				'alias' => $results['Site']['id'],
				'model' => 'SitesList',
				'foreign_key' => $results['Site']['id'],
				'parent_id' => $parent['Aco']['id'])
				);
				$this->Acl->Aco->save();
				
				/* allow all options to visit my own sites */
				$this->Acl->allow($this->Session->read('userid'), $results['Site']['id'], '*');
				
				$this->Session->setFlash(__('The site has been saved', true));
				$this->redirect(array('action' => 'MySites'));
			} else {
				$this->Session->setFlash(__('注册时发生错误，请重试。', true));
			}
		}
		$accounts = $this->Site->Account->find('list');
		$this->set(compact('accounts'));
	}

	function edit($id = null) {

		if (!$id && empty($this->data)) {
			$this->Session->setFlash(__('Invalid site', true));
			$this->redirect(array('action' => 'MySites'));
		}
		/* test acl */
		if( !$this->CheckAcl($this->Session->read('userid'), $id, 'update') )
		{
			$this->Session->setFlash(__('您没有修改该站点的权限。', true));
			$this->redirect(array('action' => 'MySites'));
		}
		else
		{
			if (!empty($this->data)) {
				if ($this->Site->save($this->data)) {
					$this->Session->setFlash(__('站点修改成功', true));
					$this->redirect(array('action' => 'MySites'));
				} else {
					$this->Session->setFlash(__('注册时发生错误，请重试', true));
				}
			}
			if (empty($this->data)) {
				$this->data = $this->Site->read(null, $id);
			}
			$accounts = $this->Site->Account->find('list');
			$this->set(compact('accounts'));	
		}
	}

	function delete($id = null) {
		if( !$this->Acl->check($this->Session->read('userid'), $id, 'delete') )
		{
			$this->Session->setFlash(__('您没有修改该站点的权限。', true));
			$this->redirect(array('action' => 'MySites'));
		}
		else
		{
			if (!$id) {
				$this->Session->setFlash(__('无效站点，该站点可能已经被删除', true));
				$this->redirect(array('action'=>'MySites'));
			}
			if ($this->Site->delete($id, true)) {
				
				/*$aco = $this->Acl->Aco->findByAlias($id);
					if( !empty($aco) )
					{
						//$this->Acl->Aco->delete($aco['Aco']['id']);
					}*/
				
				$this->Session->setFlash(__('成功删除站点', true));
				$this->redirect(array('action'=>'MySites'));
			}
			$this->Session->setFlash(__('删除站点失败', true));
			$this->redirect(array('action' => 'MySites'));
		}
	}
}
?>